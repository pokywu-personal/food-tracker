<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Macro Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; }
        .progress-transition { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-slate-900 text-white p-4 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold italic">NUTRITION.AI</h1>
            <div id="target-display" class="text-sm font-medium bg-slate-800 px-3 py-1 rounded-full"></div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-2xl">
        
        <div id="setup-panel" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center"><i class="fas fa-calculator mr-2 text-blue-500"></i> Set Your Daily Calorie Goal</h2>
            <div class="space-y-4">
                <input type="number" id="manual-target" placeholder="Enter Daily Calorie Target (e.g. 2000)" class="w-full border p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="saveInitialTarget()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">Start Tracking</button>
            </div>
        </div>

        <div id="dashboard" class="hidden space-y-4 mb-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-slate-500 font-medium">Daily Progress</span>
                    <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-600">Reset All</button>
                </div>
                <div class="text-4xl font-black mb-4"><span id="cal-curr">0</span> <span class="text-lg font-normal text-slate-400">/ <span id="cal-target-val">0</span> kcal</span></div>
                <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden">
                    <div id="cal-bar" class="bg-blue-500 h-full progress-transition" style="width: 0%"></div>
                </div>
                <div class="mt-4 flex gap-4">
                    <div class="flex-1">
                        <span class="text-xs text-slate-500 uppercase font-bold">Protein</span>
                        <div class="text-sm font-bold"><span id="pro-curr">0</span>g</div>
                    </div>
                    <div class="flex-1 border-l pl-4">
                        <span class="text-xs text-slate-500 uppercase font-bold">Status</span>
                        <div id="status-text" class="text-sm font-bold text-green-500">On Track</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="flex border-b">
                    <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600">Search</button>
                    <button onclick="switchTab('camera')" id="tab-camera" class="flex-1 py-4 font-bold text-slate-400">AI Camera</button>
                </div>

                <div class="p-6">
                    <div id="search-section">
                        <div class="relative">
                            <input type="text" id="food-search" onkeyup="if(event.key === 'Enter') searchFood()" placeholder="Search food (e.g. 1 Large Egg)" class="w-full border p-3 rounded-xl pl-10 focus:ring-2 focus:ring-blue-500 outline-none">
                            <i class="fas fa-search absolute left-3 top-4 text-slate-400"></i>
                        </div>
                        <button onclick="searchFood()" class="w-full mt-2 bg-slate-800 text-white py-2 rounded-xl text-sm font-bold">Search Database</button>
                        <div id="search-results" class="mt-4 space-y-2"></div>
                    </div>

                    <div id="camera-section" class="hidden text-center">
                        <div class="border-2 border-dashed border-slate-200 p-8 rounded-2xl mb-4 bg-slate-50">
                            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleFileUpload(event)">
                            <label for="camera-input" class="cursor-pointer">
                                <i class="fas fa-camera text-4xl text-slate-300 mb-2"></i>
                                <p class="text-slate-500">Tap to take photo or upload</p>
                            </label>
                            <img id="preview" class="hidden mt-4 rounded-lg max-h-40 mx-auto">
                        </div>
                        <p id="ai-loading" class="text-sm text-blue-500 font-bold hidden animate-pulse italic">AI is identifying ingredients...</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h3 class="font-bold mb-4">Today's Entries</h3>
                <div id="food-log" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let state = JSON.parse(localStorage.getItem('macroData')) || {
            targetCals: 0,
            logs: []
        };

        // --- CORE LOGIC ---
        function init() {
            if (state.targetCals > 0) {
                document.getElementById('setup-panel').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                updateUI();
            }
        }

        function saveInitialTarget() {
            const val = document.getElementById('manual-target').value;
            if (val > 500) {
                state.targetCals = parseInt(val);
                saveState();
                init();
            } else {
                alert("Please enter a valid calorie target.");
            }
        }

        // --- SEARCH FUNCTION (Using USDA Free API) ---
        async function searchFood() {
            const query = document.getElementById('food-search').value;
            const resultsDiv = document.getElementById('search-results');
            if (!query) return;

            resultsDiv.innerHTML = "<p class='text-sm italic text-slate-400'>Searching online database...</p>";

            try {
                // We use the Nutritionix API (Public Demo Key)
                const res = await fetch(`https://trackapi.nutritionix.com/v2/natural/nutrients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-id': 'f8f1723c', // Example Demo ID
                        'x-app-key': '2774900762df152336365f58d9299b8f' // Example Demo Key
                    },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                
                resultsDiv.innerHTML = "";
                data.foods.forEach(food => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-blue-300 cursor-pointer transition";
                    div.onclick = () => logFood(food.food_name, food.nf_calories, food.nf_protein);
                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-sm">${food.food_name}</p>
                            <p class="text-xs text-slate-500">${Math.round(food.nf_calories)} cal | ${Math.round(food.nf_protein)}g Protein</p>
                        </div>
                        <i class="fas fa-plus-circle text-blue-500"></i>
                    `;
                    resultsDiv.appendChild(div);
                });
            } catch (e) {
                resultsDiv.innerHTML = "<p class='text-red-400 text-sm'>Could not find data. Try typing '1 egg'</p>";
            }
        }

        // --- AI PHOTO HANDLER ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('preview');
            const loading = document.getElementById('ai-loading');

            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
                loading.classList.remove('hidden');

                // Simulate AI recognition delay
                setTimeout(() => {
                    loading.classList.add('hidden');
                    // In a real app, this is where we send the image to GPT-4o
                    const mockAI = { name: "Identified: Avocado Toast", cal: 350, pro: 12 };
                    logFood(mockAI.name, mockAI.cal, mockAI.pro);
                    alert(`AI Analysis: ${mockAI.name} added!`);
                }, 2000);
            }
        }

        // --- UTILS ---
        function logFood(name, cal, pro) {
            state.logs.push({
                name: name,
                cal: Math.round(cal),
                pro: Math.round(pro),
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            saveState();
            updateUI();
            // Clear search
            document.getElementById('search-results').innerHTML = "";
            document.getElementById('food-search').value = "";
        }

        function updateUI() {
            const totalCals = state.logs.reduce((sum, item) => sum + item.cal, 0);
            const totalPro = state.logs.reduce((sum, item) => sum + item.pro, 0);
            
            document.getElementById('cal-curr').innerText = totalCals;
            document.getElementById('cal-target-val').innerText = state.targetCals;
            document.getElementById('pro-curr').innerText = totalPro;
            document.getElementById('target-display').innerText = `Goal: ${state.targetCals} kcal`;

            const pct = Math.min((totalCals / state.targetCals) * 100, 100);
            document.getElementById('cal-bar').style.width = pct + "%";

            // Render Log
            const logDiv = document.getElementById('food-log');
            logDiv.innerHTML = state.logs.length === 0 ? "<p class='text-slate-400 text-sm italic'>No food logged yet.</p>" : "";
            
            state.logs.slice().reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center py-2 border-b border-slate-50";
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-sm text-slate-700">${item.name}</p>
                        <p class="text-[10px] text-slate-400 uppercase">${item.time}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-black text-blue-600">${item.cal} cal</p>
                        <p class="text-[10px] text-slate-400 font-bold">${item.pro}g P</p>
                    </div>
                `;
                logDiv.appendChild(div);
            });
        }

        function switchTab(tab) {
            const searchSec = document.getElementById('search-section');
            const cameraSec = document.getElementById('camera-section');
            const tabSearch = document.getElementById('tab-search');
            const tabCamera = document.getElementById('tab-camera');

            if (tab === 'search') {
                searchSec.classList.remove('hidden');
                cameraSec.classList.add('hidden');
                tabSearch.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                tabCamera.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            } else {
                searchSec.classList.add('hidden');
                cameraSec.classList.remove('hidden');
                tabCamera.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                tabSearch.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            }
        }

        function saveState() {
            localStorage.setItem('macroData', JSON.stringify(state));
        }

        function resetData() {
            if (confirm("Reset everything for today?")) {
                localStorage.removeItem('macroData');
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>
